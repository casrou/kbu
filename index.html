<!DOCTYPE html>

<head>
  <title>Tidligere valg af KBU forløb</title>
  <link rel="icon" type="image/x-icon" href="favicon.ico" />
  <link rel="stylesheet" href="styles.css" />
</head>

<body>
  <section class="section">
    <div class="wrapper">
      <div class="header">
        <h1>Tidligere valg af KBU forløb</h1>
        <p class="description">
          Find ud af hvad dit nummer ville have givet af muligheder i tidligere
          runder
        </p>
      </div>
      <div class="container selections">
        <div class="selection">
          <label for="input-nummer">Nummer</label>
          <input
            class="input"
            id="input-nummer"
            type="number"
            min="1"
            max="1000"
            placeholder="1"
          />
        </div>
        <div class="selection">
          <label for="input-year">År</label>
          <select id="input-year" multiple>
            <option value="0">Sommeren 2022</option>
            <option value="1">Vinteren 2022-2023</option>
            <option value="2">Sommeren 2023</option>
            <option value="3">Vinteren 2023-2024</option>
          </select>
        </div>
        <div class="selection">
          <label for="input-speciale">Speciale</label>
          <select id="input-speciale" multiple></select>
        </div>
        <div class="selection">
          <label for="input-enhed">Enhed</label>
          <select id="input-enhed" multiple></select>
        </div>
        <div class="selection">
          <label for="input-submit"><br></label>
          <input id="input-submit" type="button" value="Søg" />
        </div>
      </div>
      <div class="results container" id="results">
        <span class="table-header">Nummer</span>
        <span class="table-header">Speciale</span>
        <span class="table-header">Enhed</span>
        <span class="table-header">Afdeling</span>
      </div>
    </div>
  </section>

  <script type="module">
    const results = await fetchResults();
    populateInputs(results.flat());

    document.getElementById("input-submit").onclick = async () => {
      clearTable()

      let inputYear = document.getElementById("input-year");
      let collection = inputYear.selectedOptions;

      let populate = []
      for (let i = 0; i < collection.length; i++) {
        const element = collection[i];
        populate = populate.concat(results[element.value])
      }

      let final = populate.sort((a,b) => a.nummer - b.nummer)

      let nummer = document.getElementById("input-nummer").value
      final = filterNummer(final, nummer)
      
      let specialer = Array.from(document.getElementById("input-speciale").selectedOptions).map(o => o.label)
      final = filterSpeciale(final, specialer)

      let enheder = Array.from(document.getElementById("input-enhed").selectedOptions).map(o => o.label)
      final = filterEnhed(final, enheder)

      final.forEach(p => addResultRow(p));
    }

    function populateInputs(results) {
      var specialer = new Set();
      var enheder = new Set();
      for (let i = 0; i < results.length; i++) {
        const r = results[i];
        specialer.add(r.speciale);
        enheder.add(r.enhed);
      }

      const specialeSelect = document.getElementById("input-speciale");
      [...specialer].sort().forEach((s) => addOption(specialeSelect, s));

      const enhedSelect = document.getElementById("input-enhed");
      [...enheder].sort().forEach((e) => addOption(enhedSelect, e));
    }

    function populateTable(results) {

      let inputYear = document.getElementById("input-year");
      let collection = inputYear.selectedOptions;

      let populate = []
      for (let i = 0; i < collection.length; i++) {
        const element = collection[i];
        populate = populate.concat(results[element.value])
      }

      let sortedPopulate = populate.sort((a,b) => a.nummer - b.nummer )
      
      populate.forEach(p => addResultRow(p));
    }

    function filterNummer(results, nummer) {
      return results.filter(r => r.nummer >= nummer);
    }

    function filterSpeciale(results, specialer) {
      return results.filter(r => specialer.includes(r.speciale));
    }

    function filterEnhed(results, enheder) {
      return results.filter(r => enheder.includes(r.enhed));
    }

    async function fetchResults() {
      const results = []
      await fetch("KBU Forløb - Sommeren 2022 - Runde 29.json").then((r) => r.json()).then(r => results.push(r));
      await fetch("KBU Forløb - Vinter 2022_2023 - Runde 30.json").then((r) => r.json()).then(r => results.push(r));
      await fetch("KBU Forløb - Sommeren 2023 - Runde 31.json").then((r) => r.json()).then(r => results.push(r));
      await fetch("KBU Forløb - Vinter 2023_2024 - Runde 32.json").then((r) => r.json()).then(r => results.push(r));
      console.debug(results);
      return results;
    }

    function addResultRow(r) {
      var nummer = document.createElement("span");
      nummer.innerText = r.nummer;
      var speciale = document.createElement("span");
      speciale.innerText = r.speciale;
      var enhed = document.createElement("span");
      enhed.innerText = r.enhed;
      var afdeling = document.createElement("span");
      afdeling.innerText = r.afdeling;

      const results = document.getElementById("results");
      results.appendChild(nummer);
      results.appendChild(speciale);
      results.appendChild(enhed);
      results.appendChild(afdeling);
    }

    function clearTable() {
      var toBeRemoved = document
        .getElementById("results")
        .querySelectorAll("span:not(.table-header)");
      toBeRemoved.forEach((tbr) => tbr.remove());
    }

    function addOption(select, option) {
      var child = document.createElement("option");
      child.innerText = option;
      select.appendChild(child);
    }
  </script>
</body>
